const { SlashCommandBuilder, EmbedBuilder, ActionRowBuilder, ButtonBuilder, ButtonStyle, StringSelectMenuBuilder } = require('discord.js');
const moment = require('moment-timezone');

module.exports = {
    data: new SlashCommandBuilder()
        .setName('schedule')
        .setDescription('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å½¢å¼ã§æ—¥ç¨‹èª¿æ•´æŠ•ç¥¨ã‚’ä½œæˆã—ã¾ã™')
        .addStringOption(option =>
            option.setName('title')
                .setDescription('æŠ•ç¥¨ã®ã‚¿ã‚¤ãƒˆãƒ«')
                .setRequired(true))
        .addStringOption(option =>
            option.setName('description')
                .setDescription('æŠ•ç¥¨ã®èª¬æ˜ï¼ˆä»»æ„ï¼‰')
                .setRequired(false)),

    async execute(interaction) {
        try {
            await interaction.deferReply();

            const title = interaction.options.getString('title');
            const description = interaction.options.getString('description') || '';

            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºç”¨ã®Embedã‚’ä½œæˆ
            const calendarEmbed = new EmbedBuilder()
                .setTitle(`ğŸ“… ${title}`)
                .setDescription(description || 'ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„')
                .setColor(0x00AE86)
                .setTimestamp();

            // ç¾åœ¨ã®æœˆã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ç”Ÿæˆ
            const currentMonth = moment().tz('Asia/Tokyo');
            const calendar = generateCalendar(currentMonth);
            
            calendarEmbed.addFields({
                name: `ğŸ“† ${currentMonth.format('YYYYå¹´MMæœˆ')}`,
                value: calendar,
                inline: false
            });

            // æ—¥ä»˜é¸æŠç”¨ã®ã‚»ãƒ¬ã‚¯ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä½œæˆ
            const dateSelectMenu = createDateSelectMenu(currentMonth);
            
            // æ™‚é–“é¸æŠç”¨ã®ãƒœã‚¿ãƒ³ã‚’ä½œæˆ
            const timeButtons = createTimeButtons();
            
            // è©³ç´°è¨­å®šãƒœã‚¿ãƒ³
            const settingsButton = new ButtonBuilder()
                .setCustomId('schedule_detailed_settings')
                .setLabel('è©³ç´°è¨­å®š')
                .setStyle(ButtonStyle.Secondary)
                .setEmoji('âš™ï¸');

            const row1 = new ActionRowBuilder().addComponents(dateSelectMenu);
            const row2 = new ActionRowBuilder().addComponents(timeButtons);
            const row3 = new ActionRowBuilder().addComponents(settingsButton);

            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
            await interaction.editReply({
                embeds: [calendarEmbed],
                components: [row1, row2, row3]
            });

            await interaction.followUp({
                content: `âœ… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å½¢å¼ã®æ—¥ç¨‹èª¿æ•´ã€Œ${title}ã€ã‚’ä½œæˆã—ã¾ã—ãŸï¼\nğŸ“… æ—¥ä»˜ã¨æ™‚é–“ã‚’é¸æŠã—ã¦ã‹ã‚‰æŠ•ç¥¨ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚`,
                ephemeral: true
            });

        } catch (error) {
            console.error('scheduleã‚³ãƒãƒ³ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
            
            try {
                if (interaction.replied || interaction.deferred) {
                    await interaction.editReply({
                        content: 'âŒ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚'
                    });
                } else {
                    await interaction.reply({
                        content: 'âŒ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚',
                        ephemeral: true
                    });
                }
            } catch (replyError) {
                console.error('ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹é€ä¿¡å¤±æ•—:', replyError);
            }
        }
    },
};

// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”Ÿæˆé–¢æ•°
function generateCalendar(month) {
    const startOfMonth = month.clone().startOf('month');
    const endOfMonth = month.clone().endOf('month');
    const startOfCalendar = startOfMonth.clone().startOf('week');
    const endOfCalendar = endOfMonth.clone().endOf('week');

    let calendar = '```\n';
    calendar += 'æ—¥ æœˆ ç« æ°´ æœ¨ é‡‘ åœŸ\n';
    
    const current = startOfCalendar.clone();
    while (current.isSameOrBefore(endOfCalendar)) {
        if (current.isSame(month, 'month')) {
            const day = current.format('DD');
            const isToday = current.isSame(moment(), 'day');
            const isPast = current.isBefore(moment(), 'day');
            
            if (isToday) {
                calendar += `[${day}]`;
            } else if (isPast) {
                calendar += `~~${day}~~`;
            } else {
                calendar += ` ${day} `;
            }
        } else {
            calendar += '   ';
        }
        
        if (current.day() === 6) { // åœŸæ›œæ—¥
            calendar += '\n';
        }
        
        current.add(1, 'day');
    }
    
    calendar += '```';
    return calendar;
}

// æ—¥ä»˜é¸æŠãƒ¡ãƒ‹ãƒ¥ãƒ¼ä½œæˆ
function createDateSelectMenu(month) {
    const options = [];
    const startOfMonth = month.clone().startOf('month');
    const endOfMonth = month.clone().endOf('month');
    const today = moment().tz('Asia/Tokyo');
    
    let current = startOfMonth.clone();
    while (current.isSameOrBefore(endOfMonth)) {
        // éå»ã®æ—¥ä»˜ã¯é™¤å¤–
        if (current.isSameOrAfter(today, 'day')) {
            const dateStr = current.format('YYYY-MM-DD');
            const displayStr = current.format('MM/DD (ddd)');
            const isToday = current.isSame(today, 'day');
            
            options.push({
                label: isToday ? `ğŸ“… ${displayStr} (ä»Šæ—¥)` : displayStr,
                value: dateStr,
                description: current.format('YYYYå¹´MMæœˆDDæ—¥')
            });
        }
        
        current.add(1, 'day');
    }

    // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒç©ºã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
    if (options.length === 0) {
        options.push({
            label: 'é¸æŠå¯èƒ½ãªæ—¥ä»˜ãŒã‚ã‚Šã¾ã›ã‚“',
            value: 'no_dates',
            description: 'ä»Šæœˆã¯é¸æŠå¯èƒ½ãªæ—¥ä»˜ãŒã‚ã‚Šã¾ã›ã‚“'
        });
    }

    return new StringSelectMenuBuilder()
        .setCustomId('schedule_date_select')
        .setPlaceholder('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆéå»ã®æ—¥ä»˜ã¯é™¤å¤–ï¼‰')
        .setMinValues(1)
        .setMaxValues(Math.min(options.length, 10))
        .addOptions(options);
}

// æ™‚é–“é¸æŠãƒœã‚¿ãƒ³ä½œæˆ
function createTimeButtons() {
    const row = new ActionRowBuilder();
    
    // æ™‚é–“å¸¯ãƒœã‚¿ãƒ³
    const morningBtn = new ButtonBuilder()
        .setCustomId('schedule_time_morning')
        .setLabel('åˆå‰ (9:00-12:00)')
        .setStyle(ButtonStyle.Primary)
        .setEmoji('ğŸŒ…');
    
    const afternoonBtn = new ButtonBuilder()
        .setCustomId('schedule_time_afternoon')
        .setLabel('åˆå¾Œ (13:00-17:00)')
        .setStyle(ButtonStyle.Primary)
        .setEmoji('â˜€ï¸');
    
    const eveningBtn = new ButtonBuilder()
        .setCustomId('schedule_time_evening')
        .setLabel('å¤œ (18:00-21:00)')
        .setStyle(ButtonStyle.Primary)
        .setEmoji('ğŸŒ™');
    
    const customBtn = new ButtonBuilder()
        .setCustomId('schedule_time_custom')
        .setLabel('ã‚«ã‚¹ã‚¿ãƒ æ™‚é–“')
        .setStyle(ButtonStyle.Secondary)
        .setEmoji('â°');

    row.addComponents(morningBtn, afternoonBtn, eveningBtn, customBtn);
    return row;
}